<Module>
  <ModulePrefs title="Calendar" />
  <UserPref name="domainName" display_name="Domain Url"
    required="true" />
  <UserPref name="calendarIds" display_name="Calendar IDs"
    required="false" />
  <UserPref name="colorIds" display_name="Color IDs"
    required="false" />
  <UserPref name="assignmentColorId" display_name="AssignmentColorID"
    required="false" />
  <UserPref name="eventColorId" display_name="EventColorID"
    required="false" />
  <Content type="html">
  <![CDATA[

<div id="containerId" style ="margin-top:10px;width:100%;height:700">
  <div id="checkBoxContainer" style="width:100%;">
  </div>
  <div style="width:100%;height:500" id="frameContainer1" >
      <iframe id="defaultIFrame" style="border:0;width:100%;" frameborder="0" scrolling="no">
      </iframe>
  </div>
</div>


<style type="text/css">
    
    a:hover{
           color:#808000;
      }
    .checkbox{
          background-color:#FFF666;
      }
     
   
</style>

<script type="text/javascript" src="http://www.google.com/jsapi">

</script>
    

<script type="text/javascript">
var calendarId = "";
var assignementCalendarId = ""
var prefs = new gadgets.Prefs();
var domainName =  prefs.getString("domainName");
var calendarids =  prefs.getString("calendarIds");
var colorids =  prefs.getString("colorIds");
var assgncolId =  prefs.getString("assignmentColorId");
var eventcolId =  prefs.getString("eventColorId");
var calendarIdArray = new Array();
var domain;
 </script>
   
<script type="text/javascript" src="jscolor/jscolor.js"></script>
<script type="text/javascript">

function gup( name )
{
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
  return "";
  else
  return results[1];
 };


function getCurrentWindowHeight(){
var winW = 630, winH = 460;
if (document.body && document.body.offsetWidth) {
 winW = document.body.offsetWidth;
 winH = document.body.offsetHeight;
}
if (document.compatMode=='CSS1Compat' &&
    document.documentElement &&
    document.documentElement.offsetWidth ) {
 winW = document.documentElement.offsetWidth;
 winH = document.documentElement.offsetHeight;
}
if (window.innerWidth && window.innerHeight) {
 winW = window.innerWidth;
 winH = window.innerHeight;
}


return winH;

};


function makeJSONRequest() {   


  var pare = gup('parent');
  var temp = new Array();
  temp = pare.split('/');
  var sitename = temp[5] ;
  domain =  temp[4];
  var filt = '{"groupOp":"AND","rules":[ {"field" : "classSiteName",     "op" : "eq", "data" : "'
                        + sitename
                        + '"} ] }';

  
  var assignmentPostData = { field : "assignmentCalendarId",
                    Entity : "myClass",
                    filters : filt
};
 

        var params = {};
       params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
    params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(assignmentPostData);
    params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
        // This URL returns a JSON-encoded string that represents a JavaScript object
        var url = domainName+"/gadget/getSearchedEntityValues.do";
        gadgets.io.makeRequest(url, assignmentResponse, params);
};
  </script>



<script type="text/javascript">

var assignemntObj;

function assignmentResponse(obj){

 var pare = gup('parent');
  var temp = new Array();
  temp = pare.split('/');
  var sitename = temp[5] ;
  domain =  temp[4];
  var filt = '{"groupOp":"AND","rules":[ {"field" : "classSiteName",     "op" : "eq", "data" : "'
                        + sitename
                        + '"} ] }';
  assignemntObj = obj;
  var eventPostData = { field : "eventCalendarId",
                    Entity : "myClass",
                    filters : filt
};

  var params = {};
       params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
    params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(eventPostData );
    params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
        // This URL returns a JSON-encoded string that represents a JavaScript object
        var url = domainName+"/gadget/getSearchedEntityValues.do";
        gadgets.io.makeRequest(url, response, params);
}



function loadCalendar(address){
   var checkBoxArray = document.getElementsByTagName('input');
   var colorBoxArray = colorids.split(',');
   var renderAddress;
   if(assgncolId == "" && eventcolId == "" ){
       renderAddress ="http://www.google.com/calendar/hosted/"+ domain +"/embed?showTitle=0&src="+calendarId+"&color=%231B887A&src="+assignementCalendarId+"&color=%23875509";
} else if(assgncolId != "" && eventcolId == ""){
       renderAddress ="http://www.google.com/calendar/hosted/"+ domain +"/embed?showTitle=0&src="+calendarId+"&color=%231B887A&src="+assignementCalendarId+"&color=%23"+assgncolId;
}else if(assgncolId == "" && eventcolId != ""){
       renderAddress ="http://www.google.com/calendar/hosted/"+ domain +"/embed?showTitle=0&src="+calendarId+"&color=%23"+eventcolId +"&src="+assignementCalendarId+"&color=%23875509";
}else{
      renderAddress ="http://www.google.com/calendar/hosted/"+ domain +"/embed?showTitle=0&src="+calendarId+"&color=%23"+eventcolId +"&src="+assignementCalendarId+"&color=%23"+assgncolId;
}
     var firstTime= true;
   //var defaultColor = 'CCF999';
 
   for(var i=0;i<checkBoxArray.length;i++){
       if(checkBoxArray[i].checked){  
          renderAddress += "&src=";
          firstTime = false;
          renderAddress += checkBoxArray[i].value;
         
             if(colorBoxArray != ""){
               renderAddress += "&color=%23";
               renderAddress += colorBoxArray[i];
              }
       }
     }
var numberOfRows = Math.ceil(document.getElementsByTagName('input').length/4.0);
document.getElementById('defaultIFrame').src = renderAddress;
document.getElementById('defaultIFrame').height = getCurrentWindowHeight()-(numberOfRows*30)-14;
}



function response(obj) {
       var assignemntJsonData = assignemntObj.data;
       var jsondata = obj.data;

      for(var value = 0 ; value < jsondata.length ; value ++) {   
           var innerList = jsondata[value].key ;
           calendarId=innerList.substring(innerList.lastIndexOf("/")+1);
          }

      for(var value = 0 ; value < assignemntJsonData.length ; value ++) {
           var innerList = assignemntJsonData[value].key ;
           assignementCalendarId=innerList.substring(innerList.lastIndexOf("/")+1);
          }

 
    var linksData="";
    var array= new Array();
    var name = new Array();

if(calendarids != ""){
    var arrayOfIds = calendarids.split(",");
    var frameId = document.getElementById('checkBoxContainer');
        
          for(var value = 0 ; value < arrayOfIds.length ; value ++) {
                 var dynamicDiv = document.createElement('div');
                 dynamicDiv.style.cssText ='float:left;width:25%;height:30px';
                 name = arrayOfIds[value].split(";");
                 array[name[1]] = name[0];
                 calendarIdArray[value] = name[1].substring(name[1].lastIndexOf("/")+1);
                 var varId = "checkBoxId"+calendarIdArray[value];
                 dynamicDiv.innerHTML="";
                 dynamicDiv.innerHTML += '<input type="checkbox" class="color" id="'+varId+'" value="'+calendarIdArray[value]+'" onclick = " loadCalendar(\''+calendarIdArray[value]+'\')">'+  array[name[1]]+'<br/><br/>';
                 frameId.appendChild(dynamicDiv);
                 loadCalendar("");
           }
}else{
        loadCalendar("");
}

  };


gadgets.util.registerOnLoadHandler(makeJSONRequest);

     </script>
  ]]>
  </Content>
</Module>